# Define image with OpenMDAO and dependencies

FROM ubuntu:24.04

SHELL ["/bin/bash", "-c"]

ARG DEBIAN_FRONTEND=noninteractive

# Install updates
RUN apt-get update -y && apt-get -y install sudo vim curl wget git g++ gfortran make cmake graphviz libblas-dev liblapack-dev protobuf-compiler

# # install a browser
# RUN wget https://dl.google.com/linux/direct/google-chrome-stable_current_amd64.deb ;\
#     apt-get install -y ./google-chrome-stable_current_amd64.deb

# Create user
ENV USER=omdao
RUN adduser --shell /bin/bash --disabled-password ${USER}
RUN adduser ${USER} sudo
RUN echo '%sudo ALL=(ALL) NOPASSWD:ALL' >> /etc/sudoers

USER ${USER}
WORKDIR /home/${USER}

COPY client.py client.py

EXPOSE 50051

# Install Miniforge
RUN wget -q -O Miniforge3.sh "https://github.com/conda-forge/miniforge/releases/latest/download/Miniforge3-$(uname)-$(uname -m).sh" ;\
    bash Miniforge3.sh -b ;\
    rm Miniforge3.sh ;\
    export PATH=$HOME/miniforge3/bin:$PATH ;\
    conda init bash

# Create conda environment
RUN source $HOME/miniforge3/etc/profile.d/conda.sh ;\
    #
    # Create conda environment
    #
    conda create -n mdaowork python=3.12 'numpy<2' scipy cython swig -q -y ;\
    conda activate mdaowork ;\
    conda install matplotlib graphviz -q -y ;\
    conda install mpi4py openmpi petsc4py=3.20 pyoptsparse protobuf -q -y ;\
    python -m pip install pyparsing psutil objgraph plotly pyxdsm pydot grpcio grpcio-tools ;\
    #
    # Install build_pyoptsparse
    # (this will allow the user additional options for installing pyoptsparse, beyond the conda install above)
    #
    python -m pip install git+https://github.com/openmdao/build_pyoptsparse ;\
    # build_pyoptsparse -v ;\
    #
    # Install OpenMDAO
    #
    git clone https://github.com/OpenMDAO/OpenMDAO.git ;\
    python -m pip install -e 'OpenMDAO[test]' ;\
    #
    # Install Philote
    #
    git clone https://github.com/chrislupp/Philote-Python.git ;\
    cd Philote-Python ;\
    git submodule init ;\
    git submodule update ;\
    python -m pip install -e .

# Modify .bashrc
RUN echo "## Always activate mdaowork environment on startup ##" >> ~/.bashrc ;\
    echo "conda activate mdaowork" >> ~/.bashrc ;\
    echo "" >> ~/.bashrc ;\
    echo "## OpenMPI settings" >> ~/.bashrc ;\
    echo "export OMPI_MCA_rmaps_base_oversubscribe=1" >> ~/.bashrc ;\
    echo "export OMPI_MCA_btl=^openib" >> ~/.bashrc ;\
    echo "" >> ~/.bashrc ;\
    echo "## Required for some newer MPI / libfabric instances" >> ~/.bashrc ;\
    echo "export RDMAV_FORK_SAFE=true" >> ~/.bashrc ;\
    echo "" >> ~/.bashrc

# Make script  to run server (same as .bashrc, but run server at the end)
RUN echo "source $HOME/miniforge3/etc/profile.d/conda.sh" >> ~/run_server.sh ;\
    echo "" >> ~/run_server.sh ;\
    echo "conda activate mdaowork" >> ~/run_server.sh ;\
    echo "" >> ~/run_server.sh ;\
    echo "## OpenMPI settings" >> ~/run_server.sh ;\
    echo "export OMPI_MCA_rmaps_base_oversubscribe=1" >> ~/run_server.sh ;\
    echo "export OMPI_MCA_btl=^openib" >> ~/run_server.sh ;\
    echo "" >> ~/run_server.sh ;\
    echo "## Required for some newer MPI / libfabric instances" >> ~/run_server.sh ;\
    echo "export RDMAV_FORK_SAFE=true" >> ~/run_server.sh ;\
    echo "" >> ~/run_server.sh ;\
    echo "python server.py" >> ~/run_server.sh

# Set up a work directory that can be shared with the host operating system
WORKDIR /home/${USER}/work

# wait for user to connect
ENTRYPOINT ["tail", "-f", "/dev/null"]
